# File redirects MUST come before directory redirects to avoid prefix matching conflicts
Redirect 301 /free/models/voyah-free-ev-norway-otts.pdf /voyah-free-ev-norway-otts.pdf
Redirect 301 /free/voyah-free-evr-2021-user-manual-rus.pdf /voyah-free-evr-2021-user-manual-rus.pdf
Redirect 301 /free/voyah-free-evr-2023-user-manual-rus.pdf /voyah-free-evr-2023-user-manual-rus.pdf
Redirect 301 /free/voyah-free-evr-2024-user-manual-rus.pdf /voyah-free-evr-2024-user-manual-rus.pdf
Redirect 301 /free/voyah-free-evr-2024-user-manual-rus-alt.pdf /voyah-free-evr-2024-user-manual-rus-alt.pdf

Redirect 301 /dreamer/voyah-dreamer-phev-2022-user-manual-rus.pdf /voyah-dreamer-phev-2022-user-manual-rus.pdf

Redirect 301 /passion/voyah-passion-phev-2023-user-manual-rus.pdf /voyah-passion-phev-2023-user-manual-rus.pdf

Redirect 301 /common/tweaks/install/voyahtweaks-2.1.0.zip /voyahtweaks-2.1.0.zip

Redirect 301 /common/software/device-name/voyahchat-device-name.zip /voyahchat-device-name.zip
Redirect 301 /common/software/device-name/voyahchat-device-name-mac.zip /voyahchat-device-name-mac.zip
Redirect 301 /common/software/autokit/voyahchat-autokit.zip /voyahchat-autokit.zip
Redirect 301 /common/software/autokit/voyahchat-autokit-mac.zip /voyahchat-autokit-mac.zip
Redirect 301 /common/software/apkpure/voyahchat-apkpure.zip /voyahchat-apkpure.zip
Redirect 301 /common/software/apkpure/voyahchat-apkpure-mac.zip /voyahchat-apkpure-mac.zip
Redirect 301 /common/software/rustore/voyahchat-rustore.zip /voyahchat-rustore.zip
Redirect 301 /common/software/rustore/voyahchat-rustore-mac.zip /voyahchat-rustore-mac.zip
Redirect 301 /common/software/keyboard/voyahchat-keyboard-yandex.zip /voyahchat-keyboard-yandex.zip
Redirect 301 /common/software/keyboard/voyahchat-keyboard-yandex-mac.zip /voyahchat-keyboard-yandex-mac.zip
Redirect 301 /common/software/youtube/voyahchat-youtube.zip /voyahchat-youtube.zip
Redirect 301 /common/software/youtube/voyahchat-youtube-mac.zip /voyahchat-youtube-mac.zip
Redirect 301 /common/software/telegram/voyahchat-telegram.zip /voyahchat-telegram.zip
Redirect 301 /common/software/telegram/voyahchat-telegram-mac.zip /voyahchat-telegram-mac.zip
Redirect 301 /common/software/yandex-navi-nxp/voyahchat-yandex-navi-nxp.zip /voyahchat-yandex-navi-nxp.zip
Redirect 301 /common/software/yandex-navi-nxp/voyahchat-yandex-navi-nxp-mac.zip /voyahchat-yandex-navi-nxp-mac.zip
Redirect 301 /common/tweaks/tweaks_install-nxp.zip /tweaks_install-nxp.zip

# Directory redirects come after file redirects
Redirect 301 /common/tweaks/install-mac /common/tweaks/install
Redirect 301 /common/tweaks/install-nxp-mac /common/tweaks/install-nxp
Redirect 301 /common/software/autokit-mac /common/software/autokit
Redirect 301 /common/software/apkpure-mac /common/software/apkpure
Redirect 301 /common/software/rustore-mac /common/software/rustore
Redirect 301 /common/software/yandex-navi-nxp-mac /common/software/yandex-navi-nxp

Redirect 301 /free/choice /free/models
Redirect 301 /common/firmware/update/paid /help/firmware

DirectoryIndex index.html

RewriteEngine On

RewriteCond %{HTTP_HOST} voyahrussia.com
RewriteRule (.*) https://voyahchat.ru/$1 [R=301,L]

RewriteRule ^(.*)#(.*)$ /$1#$2 [NE,R=301,L]

# Block direct access to .html files with 404
RewriteCond %{THE_REQUEST} \.html
RewriteRule .* - [R=404,L]

RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} ^(.+)/$
RewriteRule ^(.+)/$ /$1 [R=301,L]

# Hash-prefixed images (_i*) with AVIF support - highest priority
RewriteCond %{HTTP:Accept} image/avif
RewriteCond %{DOCUMENT_ROOT}/avif/$1.avif -f
RewriteRule ^_i([a-f0-9]+)$ avif/$1.avif [L,E=IS_IMAGE:1]

# Hash-prefixed images (_i*) with WebP support - second priority
RewriteCond %{HTTP:Accept} image/webp
RewriteCond %{DOCUMENT_ROOT}/webp/$1.webp -f
RewriteRule ^_i([a-f0-9]+)$ webp/$1.webp [L,E=IS_IMAGE:1]

# Hash-prefixed images (_i*) fallback to PNG
RewriteCond %{DOCUMENT_ROOT}/png/$1.png -f
RewriteRule ^_i([a-f0-9]+)$ png/$1.png [L,E=IS_IMAGE:1]

# Hash-prefixed images (_i*) fallback to JPG
RewriteCond %{DOCUMENT_ROOT}/jpg/$1.jpg -f
RewriteRule ^_i([a-f0-9]+)$ jpg/$1.jpg [L,E=IS_IMAGE:1]

# Hash-prefixed images (_i*) fallback to SVG
RewriteCond %{DOCUMENT_ROOT}/svg/$1.svg -f
RewriteRule ^_i([a-f0-9]+)$ svg/$1.svg [L,E=IS_IMAGE:1]

# Static files with Zstd (CSS, JS, SVG, XML) - highest priority
RewriteCond %{HTTP:Accept-Encoding} zstd
RewriteCond %{DOCUMENT_ROOT}/zstd/%{REQUEST_URI}.zst -f
RewriteRule ^(.+\.(css|js|svg|xml))$ zstd/$1.zst [L,E=COMPRESSION:zstd]

# Static files with Brotli (CSS, JS, SVG, XML) - second priority
RewriteCond %{HTTP:Accept-Encoding} br
RewriteCond %{DOCUMENT_ROOT}/brotli/%{REQUEST_URI}.br -f
RewriteRule ^(.+\.(css|js|svg|xml))$ brotli/$1.br [L,E=COMPRESSION:br]

# Static files with Gzip (CSS, JS, SVG, XML) - fallback
RewriteCond %{HTTP:Accept-Encoding} gzip
RewriteCond %{DOCUMENT_ROOT}/gzip/%{REQUEST_URI}.gz -f
RewriteRule ^(.+\.(css|js|svg|xml))$ gzip/$1.gz [L,E=COMPRESSION:gzip]

# Sitemap.xml specific handling (in xml/ directory)
RewriteCond %{HTTP:Accept-Encoding} zstd
RewriteCond %{DOCUMENT_ROOT}/zstd/sitemap.xml.zst -f
RewriteRule ^sitemap\.xml$ zstd/sitemap.xml.zst [L,E=COMPRESSION:zstd]

RewriteCond %{HTTP:Accept-Encoding} br
RewriteCond %{DOCUMENT_ROOT}/brotli/sitemap.xml.br -f
RewriteRule ^sitemap\.xml$ brotli/sitemap.xml.br [L,E=COMPRESSION:br]

RewriteCond %{HTTP:Accept-Encoding} gzip
RewriteCond %{DOCUMENT_ROOT}/gzip/sitemap.xml.gz -f
RewriteRule ^sitemap\.xml$ gzip/sitemap.xml.gz [L,E=COMPRESSION:gzip]

RewriteCond %{DOCUMENT_ROOT}/xml/sitemap.xml -f
RewriteRule ^sitemap\.xml$ xml/sitemap.xml [L,E=COMPRESSION:none]

# Uncompressed static files
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^(.+\.(css|js|svg|xml))$ $1 [L,E=COMPRESSION:none]

# Root URL with Zstd support (highest priority)
RewriteCond %{HTTP:Accept-Encoding} zstd
RewriteCond %{DOCUMENT_ROOT}/zstd/index.html.zst -f
RewriteRule ^$ zstd/index.html.zst [L,E=IS_HTML:1]

# Root URL with Brotli support
RewriteCond %{HTTP:Accept-Encoding} br
RewriteCond %{DOCUMENT_ROOT}/brotli/index.html.br -f
RewriteRule ^$ brotli/index.html.br [L,E=IS_HTML:1]

# Root URL with Gzip support
RewriteCond %{HTTP:Accept-Encoding} gzip
RewriteCond %{DOCUMENT_ROOT}/gzip/index.html.gz -f
RewriteRule ^$ gzip/index.html.gz [L,E=IS_HTML:1]

# Root URL
RewriteCond %{DOCUMENT_ROOT}/index.html -f
RewriteRule ^$ index.html [L,E=IS_HTML:1]

# Single-level: /free → html/free.html (Zstd)
RewriteCond %{HTTP:Accept-Encoding} zstd
RewriteCond %{DOCUMENT_ROOT}/zstd/$1.html.zst -f
RewriteRule ^([^/]+)$ zstd/$1.html.zst [L,E=IS_HTML:1]

# Single-level: /free → html/free.html (Brotli)
RewriteCond %{HTTP:Accept-Encoding} br
RewriteCond %{DOCUMENT_ROOT}/brotli/$1.html.br -f
RewriteRule ^([^/]+)$ brotli/$1.html.br [L,E=IS_HTML:1]

# Single-level: /free → html/free.html (Gzip)
RewriteCond %{HTTP:Accept-Encoding} gzip
RewriteCond %{DOCUMENT_ROOT}/gzip/$1.html.gz -f
RewriteRule ^([^/]+)$ gzip/$1.html.gz [L,E=IS_HTML:1]

# Single-level: /free → html/free.html
RewriteCond %{DOCUMENT_ROOT}/$1.html -f
RewriteRule ^([^/]+)$ $1.html [L,E=IS_HTML:1]

# Two-level: /free/models → html/free_models.html (Zstd)
RewriteCond %{HTTP:Accept-Encoding} zstd
RewriteCond %{DOCUMENT_ROOT}/zstd/$1_$2.html.zst -f
RewriteRule ^([^/]+)/([^/]+)$ zstd/$1_$2.html.zst [L,E=IS_HTML:1]

# Two-level: /free/models → html/free_models.html (Brotli)
RewriteCond %{HTTP:Accept-Encoding} br
RewriteCond %{DOCUMENT_ROOT}/brotli/$1_$2.html.br -f
RewriteRule ^([^/]+)/([^/]+)$ brotli/$1_$2.html.br [L,E=IS_HTML:1]

# Two-level: /free/models → html/free_models.html (Gzip)
RewriteCond %{HTTP:Accept-Encoding} gzip
RewriteCond %{DOCUMENT_ROOT}/gzip/$1_$2.html.gz -f
RewriteRule ^([^/]+)/([^/]+)$ gzip/$1_$2.html.gz [L,E=IS_HTML:1]

# Two-level: /free/models → html/free_models.html
RewriteCond %{DOCUMENT_ROOT}/$1_$2.html -f
RewriteRule ^([^/]+)/([^/]+)$ $1_$2.html [L,E=IS_HTML:1]

# Three-level: /common/firmware/update → html/common_firmware_update.html (Zstd)
RewriteCond %{HTTP:Accept-Encoding} zstd
RewriteCond %{DOCUMENT_ROOT}/zstd/$1_$2_$3.html.zst -f
RewriteRule ^([^/]+)/([^/]+)/([^/]+)$ zstd/$1_$2_$3.html.zst [L,E=IS_HTML:1]

# Three-level: /common/firmware/update → html/common_firmware_update.html (Brotli)
RewriteCond %{HTTP:Accept-Encoding} br
RewriteCond %{DOCUMENT_ROOT}/brotli/$1_$2_$3.html.br -f
RewriteRule ^([^/]+)/([^/]+)/([^/]+)$ brotli/$1_$2_$3.html.br [L,E=IS_HTML:1]

# Three-level: /common/firmware/update → html/common_firmware_update.html (Gzip)
RewriteCond %{HTTP:Accept-Encoding} gzip
RewriteCond %{DOCUMENT_ROOT}/gzip/$1_$2_$3.html.gz -f
RewriteRule ^([^/]+)/([^/]+)/([^/]+)$ gzip/$1_$2_$3.html.gz [L,E=IS_HTML:1]

# Three-level: /common/firmware/update → html/common_firmware_update.html
RewriteCond %{DOCUMENT_ROOT}/$1_$2_$3.html -f
RewriteRule ^([^/]+)/([^/]+)/([^/]+)$ $1_$2_$3.html [L,E=IS_HTML:1]

# Four-level: /common/firmware/update/paid → html/common_firmware_update_paid.html (Zstd)
RewriteCond %{HTTP:Accept-Encoding} zstd
RewriteCond %{DOCUMENT_ROOT}/zstd/$1_$2_$3_$4.html.zst -f
RewriteRule ^([^/]+)/([^/]+)/([^/]+)/([^/]+)$ zstd/$1_$2_$3_$4.html.zst [L,E=IS_HTML:1]

# Four-level: /common/firmware/update/paid → html/common_firmware_update_paid.html (Brotli)
RewriteCond %{HTTP:Accept-Encoding} br
RewriteCond %{DOCUMENT_ROOT}/brotli/$1_$2_$3_$4.html.br -f
RewriteRule ^([^/]+)/([^/]+)/([^/]+)/([^/]+)$ brotli/$1_$2_$3_$4.html.br [L,E=IS_HTML:1]

# Four-level: /common/firmware/update/paid → html/common_firmware_update_paid.html (Gzip)
RewriteCond %{HTTP:Accept-Encoding} gzip
RewriteCond %{DOCUMENT_ROOT}/gzip/$1_$2_$3_$4.html.gz -f
RewriteRule ^([^/]+)/([^/]+)/([^/]+)/([^/]+)$ gzip/$1_$2_$3_$4.html.gz [L,E=IS_HTML:1]

# Four-level: /common/firmware/update/paid → html/common_firmware_update_paid.html
RewriteCond %{DOCUMENT_ROOT}/$1_$2_$3_$4.html -f
RewriteRule ^([^/]+)/([^/]+)/([^/]+)/([^/]+)$ $1_$2_$3_$4.html [L,E=IS_HTML:1]

# Five-level: /a/b/c/d/e → html/a_b_c_d_e.html (Zstd)
RewriteCond %{HTTP:Accept-Encoding} zstd
RewriteCond %{DOCUMENT_ROOT}/zstd/$1_$2_$3_$4_$5.html.zst -f
RewriteRule ^([^/]+)/([^/]+)/([^/]+)/([^/]+)/([^/]+)$ zstd/$1_$2_$3_$4_$5.html.zst [L,E=IS_HTML:1]

# Five-level: /a/b/c/d/e → html/a_b_c_d_e.html (Brotli)
RewriteCond %{HTTP:Accept-Encoding} br
RewriteCond %{DOCUMENT_ROOT}/brotli/$1_$2_$3_$4_$5.html.br -f
RewriteRule ^([^/]+)/([^/]+)/([^/]+)/([^/]+)/([^/]+)$ brotli/$1_$2_$3_$4_$5.html.br [L,E=IS_HTML:1]

# Five-level: /a/b/c/d/e → html/a_b_c_d_e.html (Gzip)
RewriteCond %{HTTP:Accept-Encoding} gzip
RewriteCond %{DOCUMENT_ROOT}/gzip/$1_$2_$3_$4_$5.html.gz -f
RewriteRule ^([^/]+)/([^/]+)/([^/]+)/([^/]+)/([^/]+)$ gzip/$1_$2_$3_$4_$5.html.gz [L,E=IS_HTML:1]

# Five-level (if needed): /a/b/c/d/e → html/a_b_c_d_e.html
RewriteCond %{DOCUMENT_ROOT}/$1_$2_$3_$4_$5.html -f
RewriteRule ^([^/]+)/([^/]+)/([^/]+)/([^/]+)/([^/]+)$ $1_$2_$3_$4_$5.html [L,E=IS_HTML:1]

# Zstd compressed files (including hash-prefixed)
<FilesMatch "(\.(html|css|js|svg|xml)|^_[cjs][a-f0-9]+)\.zst$">
    Header always set Content-Encoding "zstd"
    Header always set Vary "Accept-Encoding"
</FilesMatch>

# Brotli compressed files (including hash-prefixed)
<FilesMatch "(\.(html|css|js|svg|xml)|^_[cjs][a-f0-9]+)\.br$">
    Header always set Content-Encoding "br"
    Header always set Vary "Accept-Encoding"
</FilesMatch>

# Gzip compressed files (including hash-prefixed)
<FilesMatch "(\.(html|css|js|svg|xml)|^_[cjs][a-f0-9]+)\.gz$">
    Header always set Content-Encoding "gzip"
    Header always set Vary "Accept-Encoding"
</FilesMatch>

# Content-Type headers for specific file types (all compression formats)
<FilesMatch "\.(html|htm)(\.zst|\.br|\.gz)?$">
    Header set Content-Type "text/html;charset=utf-8"
</FilesMatch>

<FilesMatch "\.css(\.zst|\.br|\.gz)?$">
    Header set Content-Type "text/css;charset=utf-8"
</FilesMatch>

<FilesMatch "\.js(\.zst|\.br|\.gz)?$">
    Header set Content-Type "application/javascript;charset=utf-8"
</FilesMatch>

<FilesMatch "\.svg(\.zst|\.br|\.gz)?$">
    Header set Content-Type "image/svg+xml;charset=utf-8"
</FilesMatch>

<FilesMatch "\.xml(\.zst|\.br|\.gz)?$">
    Header set Content-Type "application/xml;charset=utf-8"
</FilesMatch>

# Hash-prefixed CSS files (_c*) - all compression formats
<FilesMatch "^_c[a-f0-9]+(\.zst|\.br|\.gz)?$">
    Header set Content-Type "text/css;charset=utf-8"
</FilesMatch>

# Hash-prefixed JS files (_j*) - all compression formats
<FilesMatch "^_j[a-f0-9]+(\.zst|\.br|\.gz)?$">
    Header set Content-Type "application/javascript;charset=utf-8"
</FilesMatch>

# Hash-prefixed SVG files (_s*) - all compression formats
<FilesMatch "^_s[a-f0-9]+(\.zst|\.br|\.gz)?$">
    Header set Content-Type "image/svg+xml;charset=utf-8"
</FilesMatch>

# Image format Content-Type headers
<FilesMatch "\.avif$">
    Header set Content-Type "image/avif"
</FilesMatch>

<FilesMatch "\.webp$">
    Header set Content-Type "image/webp"
</FilesMatch>

<FilesMatch "\.(png)$">
    Header set Content-Type "image/png"
</FilesMatch>

<FilesMatch "\.(jpg|jpeg)$">
    Header set Content-Type "image/jpeg"
</FilesMatch>

<FilesMatch "\.gif$">
    Header set Content-Type "image/gif"
</FilesMatch>

<FilesMatch "\.ico$">
    Header set Content-Type "image/x-icon"
</FilesMatch>

# Vary header for all image formats (for content negotiation)
<FilesMatch "\.(avif|webp|png|jpg|jpeg|gif|svg)$">
    Header always set Vary "Accept"
</FilesMatch>

<FilesMatch "\.pdf$">
    Header set Content-Type "application/pdf"
</FilesMatch>

<FilesMatch "\.zip$">
    Header set Content-Type "application/zip"
</FilesMatch>

# Hash-prefixed image files (_i*)
<FilesMatch "^_i[a-f0-9]+$">
    Header always set Cache-Control "public,immutable"
    Header always set Vary "Accept"
</FilesMatch>

# Security headers for HTML pages
<FilesMatch "\.(html|htm)(\.zst|\.br|\.gz)?$">
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</FilesMatch>

# Cache-Control headers
# HTML pages - no-cache
<FilesMatch "\.(html|htm)(\.zst|\.br|\.gz)?$">
    Header always set Cache-Control "public,no-cache"
</FilesMatch>

# Hashed static files (CSS, JS, images) - immutable
<FilesMatch "\.(css|js|svg|jpg|jpeg|png|gif|ico|avif|webp)(\.zst|\.br|\.gz)?$">
    Header always set Cache-Control "public,immutable"
</FilesMatch>

# Hash-prefixed files (_c*, _j*, _s*, _i*) - immutable
<FilesMatch "^_[cjsi][a-f0-9]+(\.zst|\.br|\.gz)?$">
    Header always set Cache-Control "public,immutable"
</FilesMatch>

# PDF, ZIP, XML
<FilesMatch "\.(pdf|zip|xml)(\.zst|\.br|\.gz)?$">
    Header always set Cache-Control "public,no-cache"
</FilesMatch>

ExpiresActive On

# Hashed static files (CSS, JS, images) - 10 years
<FilesMatch "\.(css|js|svg|jpg|jpeg|png|gif|ico|avif|webp)(\.zst|\.br|\.gz)?$">
    ExpiresDefault "access plus 10 years"
</FilesMatch>

# Hash-prefixed files (_c*, _j*, _s*, _i*) - 10 years
<FilesMatch "^_[cjsi][a-f0-9]+(\.zst|\.br|\.gz)?$">
    ExpiresDefault "access plus 10 years"
</FilesMatch>

# PDF, ZIP, XML - 1 hour
<FilesMatch "\.(pdf|zip|xml)(\.zst|\.br|\.gz)?$">
    ExpiresDefault "access plus 1 hour"
</FilesMatch>
